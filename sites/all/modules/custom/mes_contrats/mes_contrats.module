<?php
module_load_include('module','ws_client');

/**
 * Implements hook_requirements()
 */
function mes_contrats_requirements($phase) {
  $requirements = array();
  if ($phase == 'runtime') {
    $t = get_t();
    if ($path = libraries_get_path('fpdf')) {
      if (file_exists($path . '/fpdf.php')) {
        $requirements['fpdf'] = array(
          'title' => $t('FPDF'),
          'value' => $t('fpdf.php found under !path', array('!path' => $path . '/fpdf.php')),
          'severity' => REQUIREMENT_OK,
        );
        return $requirements;
      }
    }
    $requirements['fpdf'] = array(
      'title' => $t('FPDF'),
      'value' => $t('FPDF library was not found. !download the library and place in under sites/all/libraries/fpdf, so that the library can be found at sites/all/libraries/fpdf/fpdf.php.', array('!download' => l(t('Download'), 'http://www.fpdf.org/'))),
      'severity' => REQUIREMENT_ERROR,
    );
  }
  return $requirements;
}
/**
 * Implements hook_libraries_info().
 */
function mes_contrats_libraries_info() {
  $libraries = array();
  $libraries['fpdf'] = array(
    'name' => 'FPDF',
    'vendor url' => 'http://www.fpdf.org/',
    'download url' => 'http://www.fpdf.org/',
    'files' => array(
      'php' => array(
        'fpdf.php',
      ),
    ),
    'version arguments' => array(
      'file' => 'fpdf.php',
      'pattern' => '/((\d+).(\d+))/',
      'lines' => 6,
    ),
  );

  return $libraries;
}

function mes_contrats_menu() {
  $items['contrat/%'] = array(
    'page callback' => 'detail_contrat',
    'page arguments' => array(1),
    'access callback' => TRUE,
  );

  return $items;
}

function detail_contrat($arg) {
  libraries_load('fpdf');
  $contrat =  ws_client_get_contrat_by_num($arg);

  $html = $contrat['thead']['num_contrat'] . ':' . $contrat['tbody']['num_contrat'] . ',' . $contrat['thead']['type'] . ':' . $contrat['tbody']['type'] . ',' .$contrat['thead']['marque'] . ':' . $contrat['tbody']['marque'];  
  
  $pdf=new FPDF();
  $pdf->AddPage();
  $pdf->SetFont('Arial','B',16);
  $pdf->Cell(40,10,$html);
  $pdf->Output();

}



/**
 * Implements hook_block_info()
 */
function mes_contrats_block_info() {
  return array(
    'mes_contrats' => array(
      'info' => t('Contrats client'),
      'cache' => DRUPAL_NO_CACHE,
    ),
  );
}

/**
 * Implements hook_block_view()
 */
function mes_contrats_block_view($delta = '') {
  if ($delta == 'mes_contrats') {
    $title = '';
  	$output = '';
    $auto = array();

/*    $auto['type'] = 'Auto';
    $auto['info'][] = array(
      'id' => '1234',
      'marque' => 'lorem',
      'modele' => 'assurance',  
    );
    $auto['info'][] = array(
      'id' => 'id',
      'marque' => 'marque',
      'modele' => 'modele',  
    );*/
/*
    $get_test_contrats = array(
      array(
        'type' => 'Auto',
        'info' => array(
                    array(
                      'id' =>'CNTR00000027',
                      'modele' => 'AUTO ECO',
                      'marque' => 'BMW',
                    ),
                    array(
                      'id' =>'CNTR00000027',
                      'modele' => 'CONFORT',
                      'marque' => 'Mercedes',
                    ),
                  ),
      ),

      array(
        'type' => 'Habitation',
        'info' => array(
                    array(
                      'id' =>'CNTR00000031',
                      'type_logement' => 'MRH PREMIUM',
                      'adresse' => 'Mermoz',
                    ),
                  ),
      ),

      array(
        'type' => 'Accident',
        'info' => array(
                    array(
                      'id' =>'CNTR00000024',
                      'produit' => 'Individuelle Accident',
                    ),
                  ),
      ),

    );

*/
    $get_service_contrats = ws_client_get_liste_contrats();
    /*$get_service_contrats = isset($get_service_contrats) ? $get_service_contrats : $get_test_contrats;
*/
    $title .=   t('Mes Contrats');
    $output .= '<div class="item-mes-contrats">';
    foreach ($get_service_contrats as $contrat) {
      # code...
        if(isset($contrat['type']))
        {
          $output .=   '<h3>';
          $output .=     'Assurance '. $contrat['type'];
          $output .=   '</h3>';
          $output .=   '<div class="row item-contrat">';
          foreach ($contrat['info'] as $informations) {
            # code...
            $i = 0;
            $numContrat = $informations['id'];
            foreach ($informations as $key => $value) {
              # code...
              if($i==0){
                $output .=     '<div class="col-lg-3 field-contrat">';
                $output .=       '<span>'.l($value,'contrat/'. $numContrat).'</span>';       
                $output .=     '</div>';    
              }
              elseif($i==1){
                $output .=     '<div class="col-lg-4 field-contrat">';
                $output .=       '<span>'. $value .'</span>';      
                $output .=     '</div>'; 
              }
              else{
                $output .=     '<div class="col-lg-2 field-contrat">';
                $output .=       '<span>'. $value .'</span>';      
                $output .=     '</div>';
              }
              $i++;

            }
            
            $path= drupal_get_path('module','mes_contrat').'contrat-pdf.php';
            $output .=     '<div class="col-lg-1 telechargement-contrat field-contrat">';
            $output .=       '<a href="'.$path.'" download="contrat-pdf.php"><i class="fa fa-download" aria-hidden="true"></i></a>';      
            $output .=     '</div>';
            $output .=     '<div class="col-lg-1 visualisation-contrat field-contrat">';
            $output .=       '<a href="http://localhost/pdf" target="_blank"><i class="fa fa-eye" aria-hidden="true"></i></a>';      
            $output .=     '</div>';
            $output .=     '<div class="col-lg-1 requete-contrat field-contrat">';
            $output .=       '<a href="#"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></a>';      
            $output .=     '</div>';
          }
          $output .=   '</div>';
      }    
    }
    $output .= '</div>';

    return array(
      'subject' => $title ,
      'content' => (!empty($output)) ? '<div class="contrat_body">' . $output . '</div>' : '<p>' . t('For now, this list is empty!') . '</p>',
    );
  }

  return array();
}