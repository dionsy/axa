<?php
	/**
	* @file
	* Web services Client
	*/
function  ws_client_block_info() {
	$blocks['ws_client_block_info'] = array('info' => t('web service client'));
	return $blocks ;
}
function  ws_client_block_view($delta = '') {
	$block['content'] = '<h1>Web Services client</h1>';
	$get_node_result = ws_client_getClient_node();
	/*krumong('main')->kPrint($get_node_result);*/	
	$data = json_decode($get_node_result->data);
	/*krumong('main')->kPrint($data);*/
	return $block ;
}

function ws_client_get_node(){
	$url = 'http://192.168.43.145/ServicesCompte.svc/compte/espaceClient/AXA00000004/' ;
  $options = array('timeout' => 6000.0) ;
	return drupal_http_request($url , $options) ;
}


function ws_client_getIdClient($numeroContrat){
	$url = "http://192.168.43.145/Service1.svc/compte/espaceClient/id/". $numeroContrat ."";

  $options = array('timeout' => 6000.0) ;
	$request = drupal_http_request($url ,$options) ;
  /*var_dump($request->data);die();*/
  return drupal_json_decode($request->data);
}

function ws_client_getInfoUser(){
  global $user;
  $account = user_load($user->uid);
  $identifiant = $account->field_identifiant_client['und'][0]['value'] ;

  $url = "http://192.168.200.13/Service1.svc/compte/espaceClient/infos/" .$identifiant. "";
  $options = array('timeout' => 6000.0) ;
  $request = drupal_http_request($url ,$options) ;
  $data = drupal_json_decode($request->data) ;
  
  $returnArray = array(
    'nom' => $data['nom'] ,
    'prenom' => $data['prenom'] ,
    'adresse' => $data['adresse'] ,
    'telephone' => $data['telephone'] ,
    'mail' => $data['mail'], 
  );

  return $returnArray ;
}

function ws_client_get_info_conseiller(){
  global $user;
  $account = user_load($user->uid);
  $identifiant = $account->field_identifiant_client['und'][0]['value'] ;
 
  $url = "http://192.168.43.145/Service1.svc/conseiller/" .$identifiant. "";
  $options = array('timeout' => 6000.0) ;
  $request = drupal_http_request($url ,$options) ;
  $data = drupal_json_decode($request->data) ;
   
  $returnArray = array(
    'nomComplet' => $data['nomComplet'] ,
    'adresse' => $data['adresse'] ,
    'telephone' => $data['telephone'] ,
    'mail' => $data['mail'], 
  );
   
  return $returnArray ;
}

function ws_client_update_info_user($array_data) {
  global $user;
  $account = user_load($user->uid);
  $identifiant = $account->field_identifiant_client['und'][0]['value'] ;

  $array_data['id'] = $identifiant;
  $data = drupal_json_encode($array_data);

  $options = array(
                  'method' => 'PUT',
                  'data' => $data,
                  'timeout' => 6000.0,
                  'headers' => array('Content-Type' => 'application/json')
  );

  $url = 'http://192.168.43.145/Service1.svc/compte/update';

  $result = drupal_http_request($url, $options);
          
}




/*function ws_client_getIdentifiant_node(){

	$url = 'http://192.168.43.145/ServicesCompte.svc/compte/espaceClient/AXA00000004/' ;
	return drupal_http_request($url) ;
}*/
function ws_client_user_login(&$edit, $account) {
  $edit['redirect'] = 'node/123';
}

function ws_client_user_presave(&$edit, $account, $category) {
   global $user;
   if($user->uid != 1)
   {
  	$numContrat = $edit['field_numero_contrat']['und'][0]['value']	 ;
  	$result = ws_client_getIdClient($numContrat);	
   /* if($result != 'false')*/
  		$edit['field_identifiant_client']['und'][0]['value'] = $result ;
    }  
}
function ws_client_webform_submission_presave($node, &$submission) {
      var_dump($submission) ;  die();
    global $user;
   $account = user_load($user->uid);
  /*$identifiant = $account->field_identifiant_client['und'][0]['value'] ;*/
        $nid = $node->nid ;
      if($nid == '8')
      {
            $carrosserieObject = taxonomy_term_load($submission->data[12][0]) ;
            $carroserie = $carrosserieObject->name ;
            $idCarroserie = $carrosserieObject->tid ;
            $modeleVehiculeObjectParent = taxonomy_get_parents($idCarroserie) ;
            $modeleVehiculeObject = reset($modeleVehiculeObjectParent) ;
            $modeleVehicule = $modeleVehiculeObject->name ;
            $idmodel = $modeleVehiculeObject->tid ;
            $marqueObjectParent = (taxonomy_get_parents($idmodel)) ;
            $marqueObject  = reset($marqueObjectParent) ;
            $marque = $marqueObject->name ;
            $devis = array(
             'idCompte' => '' ,
             'nom' => $submission->data[1][0] ,
             'prenom' => $submission->data[2][0] , 
            /* 'dateNaissance' => $submission->data[3][0] ,*/ 
             'telephone' => $submission->data[5][0]  ,
             'mail' => $submission->data[4][0] ,
            /* 'dateMiseCirculation' => $submission->data[19][0] ,*/
             /*'ageObtentionPermis' => $submission->data[16][0] ,*/
             'carburant' => $submission->data[13][0] ,
             'valeurAneuf' => $submission->data[20][0] ,
          /*   'emailDuconducteurPrincipal' => $submission->data[17][0] ,*/
             'marque' =>  $marque ,
             'carosserie' => $carroserie ,
             'modele' => $modeleVehicule,
             'puissane' => $submission->data[18][0]
             /*'adresse' => $submission->data[21][0] */
             /*'anneeDeNaissanceconducteur' => $submission->data[15][0] */
             );
             /* var_dump($devis); die();*/
            $data = drupal_json_encode($devis);

              $options = array(
                              'method' => 'POST',
                              'data' => $data,
                              'timeout' => 6000.0,
                              'headers' => array('Content-Type' => 'application/json')
              );

              $result = drupal_http_request('http://192.168.43.145/Service1.svc/devisAuto/create', $options);
                  
        }
         if($nid == '9')
          { 
            $devis = array(
             'idCompte' => $identifiant ,
             'nom' => $submission->data[8][0],
             'prenom' => $submission->data[9][0], 
             'telephone' => $submission->data[11][0],
             'mail' => $submission->data[12][0],
             'typeLogement' => $submission->data[1][0],
             'adresseLogement' => $submission->data[4][0],
             'nbPieces' =>  $submission->data[2][0],
             'principal' => $submission->data[3][0],
             'locataire' => $submission->data[14][0],
             'montant' => '5000000'
             );
              /*var_dump($devis); die();*/
            $data = drupal_json_encode($devis);

              $options = array(
                              'method' => 'POST',
                              'data' => $data,
                              'timeout' => 6000.0,
                              'headers' => array('Content-Type' => 'application/json')
              );

              $result = drupal_http_request('http://192.168.43.145/Service1.svc/devisHabitation/create', $options);
              var_dump( $result) ; die();
          }
           webform_submission_delete($nid, $sid);
}



function  _clientResource_create($userName /*, $emailUser , $numTel ,$numContrat ,$codeConfidentiel*/) {
		$userName = 12;
/*		$emailUser = "syllababacar@yahoo.fr";
		$numTel = 778241624 ;
		$numContrat = "CNTR00000001";
		$codeConfidentiel = 1234;*/

		$result_json = array('name' => 'test', 'age' => '16');
		/*$data= json_encode($result_json);*/
		header('Content-type: application/json');
	  /*$get_node_result = ws_client_getClient_node($numContrat);	
	  	$date_add() = json_decode($get_node_result->data);
	if (isset($data)) {
		return $data;
		
	}
	else		*/																											

      return $data;
 }
